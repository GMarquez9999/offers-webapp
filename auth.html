<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>MRKT TOKEN</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{font-family:sans-serif;padding:25px}
textarea{width:100%;height:120px;font-size:14px}
button{padding:10px 14px;margin-top:10px}
</style>
</head>

<body>

<h2>Получение токена...</h2>

<div id="status">Жди...</div>

<textarea id="token" readonly></textarea>
<button onclick="copy()">Скопировать</button>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const initData = tg.initData;

if (!initData) {
    document.getElementById("status").innerText =
        "Открой страницу через кнопку Telegram!";
    throw new Error("no initData");
}

// достаём photo_url из initData
function getPhoto(initData){
    const params = new URLSearchParams(initData);
    const user = JSON.parse(params.get("user"));
    return user.photo_url;
}

fetch("https://api.tgmrkt.io/api/v1/auth", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
        appId: null,
        data: initData,
        photo: getPhoto(initData)
    })
})
.then(r=>r.json())
.then(data=>{
    document.getElementById("status").innerText = "ГОТОВО";
    document.getElementById("token").value = data.token;
})
.catch(e=>{
    document.getElementById("status").innerText = "Ошибка";
});

function copy(){
    const t = document.getElementById("token");
    t.select();
    document.execCommand("copy");
}
</script>

</body>
</html>
